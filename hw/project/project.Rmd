---
title: "STAT 240: Project Draft"
author: "Jon, Mai Tah, Michitake, Sophie"
date: "Fall 2024"
output: rmdformats::readthedown
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = TRUE,
                      error = FALSE, fig.height = 4)
library(tidyverse)
source("../../scripts/ggprob.R")

theme_set(theme_minimal())

```

```{r, include=FALSE}
drugusage = read.csv("../../data/drug_consumption.csv")
   
# drug_data = drugusage %>%
#   select(Age, Alcohol) %>%
#   group_by(Age) %>% 
#   mutate(
#     usage_score = case_when(
#       Alcohol == "CL0" ~ 0,
#       Alcohol == "CL1" ~ 0,
#       Alcohol == "CL2" ~ 0,
#       Alcohol == "CL3" ~ 0,
#       Alcohol == "CL4" ~ 1,
#       Alcohol == "CL5" ~ 1,
#       Alcohol == "CL6" ~ 1,
#     ),
#     age = case_when(
#       Age == -0.95197 ~ "18-24",
#       Age == -0.07854 ~ "25-34",
#       Age == 0.49788 ~ "35-44",
#       Age == 1.09449 ~ "45-54",
#       Age == 1.82213 ~ "55-64",
#       Age == 2.59171 ~ "65+"
#     )
#   )  %>% ungroup() %>% 
#   relocate(age, .after = Age) %>%
#   select(-Age)

drug_mod = drugusage %>%
  select(Age, Alcohol) %>%
  group_by(Age) %>% 
  mutate(
    usage_score = case_when(
      Alcohol == "CL0" ~ "nonregular",
      Alcohol == "CL1" ~ "nonregular",
      Alcohol == "CL2" ~ "nonregular",
      Alcohol == "CL3" ~ "nonregular",
      Alcohol == "CL4" ~ "regular",
      Alcohol == "CL5" ~ "regular",
      Alcohol == "CL6" ~ "regular",
    )
  ) %>% group_by(Age, usage_score) %>% 
  summarize(
    n = n()
  ) %>% pivot_wider(names_from = usage_score, values_from = n) %>%
  ungroup() %>%
  mutate(
    n = regular + nonregular,
    usage_prop = regular/n,
    age = case_when(
      Age == -0.95197 ~ "18-24",
      Age == -0.07854 ~ "25-34",
      Age == 0.49788 ~ "35-44",
      Age == 1.09449 ~ "45-54",
      Age == 1.82213 ~ "55-64",
      Age == 2.59171 ~ "65+"
    )
  ) %>%
  relocate(age, .after = Age) %>%
  select(-Age)


```


## Statistical Analysis

### Initial Perspective

* First, we will set up our data to determine who is a regular drinker vs. who is an irregular drinker. We will categorize those who have drank alcohol in the past month as a regular drinker (CL4-CL6), and everyone who has not drank in the past year as an irregular drinker (CL0-CL3).

```{r echo=FALSE}
x = drug_mod$regular
n = drug_mod$n
p = (x[1:6] + 1) / (n[1:6] + 2)
sd = (p[1:6] * (1 - p[1:6])/n[1:6])

pe = p[2:6] - p[1]

se_single = sqrt(p[1:6] * (1 - p[1:6])/ n[1:6])

se = sqrt(se_single[1]^2 + se_single[2:6]^2)

conf_score = qnorm(.975)

moe = conf_score * se[1:5]

left = pe[1:5] - moe[1:5]
right = pe[1:5] + moe[1:5]

# prop = tibble(age = c("18-24", "25-34", "35-44", "45-54", "55-64", "65+"), x = x, n = n, p = p, se = se_single)

conf_int = tibble(difference = c("18-24 to 25-34", "18-24 to 35-44", "18-24 to 45-54", "18-24 to 55-64", "18-24 to 65+"), left = left, right = right) #unsure if we need confidence intervals to answer any of our proposed questions

ggplot(drug_mod, aes(y = usage_prop, color = age)) +
  geom_boxplot() + 
  facet_wrap(facets = vars(age)) + 
  labs(title = "Proportion of age group that drinks", y = "Proportion", color = "Age group") + theme_minimal()
```

* The graphs show that the proportion decreases as the age group gets older, but we will conduct further analysis to make this conclusion more accurately.

<!-- * What is our estimate of the difference between the probability a person drinks regularly while young (18-24) and while in a different age group? -->

### Statistical Model

We wish to explore if the average proportion of drinkers changes between age groups. To do this we will let: 

- $X_i$ represent the statistical model of regular drinkers for $i$ age group.
- $n_i$ represent the total number of cases for each age group.
- $p_i$ represent the true proportion of drinkers for each age group.
- $i$ represent the the groups with $1$ being ages 18-24, $2$ being 25-34, etc.

and we will use these models.

$$
X_1 \sim \text{Binom}(n_1, p_1) \\
X_2 \sim \text{Binom}(n_2, p_2) \\
X_3 \sim \text{Binom}(n_3, p_3) \\
X_4 \sim \text{Binom}(n_4, p_4) \\
X_5 \sim \text{Binom}(n_5, p_5) \\
X_6 \sim \text{Binom}(n_6, p_6) 
$$
We will assume that the BINS assumptions are met as such:
- B: Each case is binomial, either a regular drinker or a non-regular drinker.
- I: Each case is independent from each other.
- N: The number of cases is predetermined.
- S: The probability for each case remains the same.

The assumption of independence is could be potentially not met since drinking tends to be a social activity, thus one regular drinker could affect another person.

### Hypothesis

*